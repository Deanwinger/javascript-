<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>game test</title>
    <style media="screen">
      canvas{
        border: 1px black solid;
      }
    </style>
    <script src="guagame.js"></script>
    <script src="paddle.js"></script>
    <script src="block.js"></script>
    <script src="ball.js"></script>
    <script src="utils.js"></script>
    <script src="levels.js"></script>

  </head>
  <body>
    <!-- #0 canvas -->
    <canvas id="id-canvas" width="800" height="600"></canvas>
    <script>
    //tip one 最外层只能有函数, 不能有变量
    var loadlevel = function(n){
      n = n - 1
      var level = levels[n]
      var blocks=[]
      for (var i=0; i < level.length; i++){
        var p = level[i]
        var b = Block(p)
        //set coordinate x, y
        blocks.push(b)
      }
      return blocks
    }
    var _main = function() {
      var game = GuaGame(30)

      var paddle = Paddle()

      var ball = Ball()
      //#1 document
      var blocks = loadlevel(1)


      var paused = false
      game.registerAction('a', function(){
        paddle.moveLeft()
      })

      game.registerAction('d', function(){
        paddle.moveRight()
      })

      game.registerAction('f', function(){
        ball.fire()
      })

      window.addEventListener('keydown', function(event){
        var k = event.key
        if (event.key == 'p'){
          paused = !paused
        }else if ('1234567'.includes(k)){
          blocks = loadlevel(Number(k))
        }
      })

      game.update = function(){
        if (paused){
          return
        }
        ball.move()
        if (paddle.collide(ball)){
          ball.bounceBack()
        }
        for (var i=0; i < blocks.length; i++){
          var block = blocks[i]
          if (block.collide(ball)){
            block.kill()
            ball.bounceBack()
          }
        }

      }

      game.draw = function(){
        game.drawImage(paddle)
        game.drawImage(ball)
        for (var i=0; i < blocks.length; i++){
          if (blocks[i].alive){
            game.drawImage(blocks[i])
          }
        }
      }
    }

    _main()
    </script>
  </body>
</html>
