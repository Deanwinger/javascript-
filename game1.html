<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>game 1</title>
  <style media='screen'>
    canvas {
      border: 1px black solid;
    }
  </style>
  <script src="utils.js"></script>
  <script src="guagame.js"></script>
  <script src="ball.js"></script>
  <script src="paddle.js"></script>
  <script src="block.js"></script>
  <script src="level.js">

  </script>
</head>

<body>
  <canvas id="id-canvas" width="1000" height="800"></canvas>
  <hr>
  <input id='id-input-speed', type="range" value="1">
  <script>
  var loadlevel = function(n){
    n = n - 1
    var level = levels[n]
    var blocks = []
    for (var i = 0; i < level.length; i++) {
      var p = level[i]
      var b = Block(p)
      blocks.push(b)
    }
    return blocks
  }

  var blocks = []
  var enableDebugMode = function(enable){
    if(!enable){
      return
    }
    window.paused = false
    window.addEventListener('keydown', function(event){
      var k = event.key
      if(k == 'p'){
        //pause function
        window.paused = !window.paused
      }else if('1234567'.includes(k)){
        // 为了 debug 临时加的载入关卡功能
        blocks = loadlevel(Number(k))
      }
    })
    //控制速度
    document.querySelector('#id-input-speed').addEventListener('input', function(event){
      var input = event.target
      window.fps = Number(input.value)
    })
  }


  // 瓜
  var __main = function() {
      enableDebugMode(true)

      var game = GuaGame(30)

      var paddle = Paddle()

      var ball = Ball()

      blocks = loadlevel(1)

      var paused = false

      game.registerAction('a', function(){
          paddle.moveLeft()
      })
      game.registerAction('d', function(){
          paddle.moveRight()
      })
      game.registerAction('f', function(){
          ball.fire()
      })
      game.update = function() {
          if(window.paused){
            return
          }

          ball.move()
          // 判断相撞
          if (paddle.collide(ball)) {
              // 这里应该调用一个 ball.反弹() 来实现
              ball.bounceBack()
          }
          //判断ball和block是否相撞
          for (var i = 0; i < blocks.length; i++) {
            var block = blocks[i]
            if (block.collide(ball)){
              block.kill()
              //ball 反弹
              ball.bounceBack()
            }
          }
        }

      game.draw = function() {
          // draw
          game.drawImage(paddle)
          game.drawImage(ball)
          for (var i = 0; i < blocks.length; i++){
            var block = blocks[i]
            if (block.alive) {
              game.drawImage(block)
            }
          }
      }
  }
  __main()
  </script>
</body>

</html>
